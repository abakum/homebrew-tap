name: Auto-update Casks

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write    # Required for direct push to main

jobs:
  update-cask:
    runs-on: macos-latest  # Need macOS for DMG SHA256 calculation
    
    steps:
      # Step 1: Checkout repository and setup Homebrew
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@main

      # Step 2: Check if update is available using brew livecheck
      - name: Check for cask updates
        id: check_update
        run: |
          echo "Checking for updates to crocgui cask..."
          
          # Get livecheck data in JSON format
          LIVECHECK_JSON="$(brew livecheck --cask --json abakum/tap/crocgui 2>/dev/null || echo '[]')"
          
          # Parse JSON to get version information
          CURRENT_VERSION="$(echo "${LIVECHECK_JSON}" | jq -r '.[0].version.current // empty')"
          LATEST_VERSION="$(echo "${LIVECHECK_JSON}" | jq -r '.[0].version.latest // empty')"
          
          echo "Current version: ${CURRENT_VERSION}"
          echo "Latest version:  ${LATEST_VERSION}"
          
          # Determine if update is needed by comparing versions
          if [[ -n "${CURRENT_VERSION}" ]] && [[ -n "${LATEST_VERSION}" ]] && [[ "${CURRENT_VERSION}" != "${LATEST_VERSION}" ]]; then
            echo "Update available: ${CURRENT_VERSION} â†’ ${LATEST_VERSION}"
            {
              echo "UPDATE=true"
              echo "NEW_VERSION=${LATEST_VERSION}"
              echo "OLD_VERSION=${CURRENT_VERSION}"
            } >> "${GITHUB_OUTPUT}"
          else
            echo "Cask is up to date (${CURRENT_VERSION})"
            echo "UPDATE=false" >> "${GITHUB_OUTPUT}"
          fi

      # Step 3: Update cask file with new version and SHA256 hashes
      - name: Update cask file
        if: steps.check_update.outputs.UPDATE == 'true'
        env:
          CASK_FILE: "Casks/crocgui.rb"
          NEW_VERSION: "${{ steps.check_update.outputs.NEW_VERSION }}"
          OLD_VERSION: "${{ steps.check_update.outputs.OLD_VERSION }}"
        run: |
          echo "Downloading new releases to calculate SHA256 hashes..."
          
          # Function to calculate SHA256 hash of a URL
          get_sha256() {
            local url="$1"
            local temp_file
            temp_file="$(mktemp)"
            
            # Download file (silently with follow redirects)
            curl -sL "${url}" -o "${temp_file}"
            
            # Calculate SHA256 hash (use shasum on macOS)
            shasum -a 256 "${temp_file}" | awk '{print $1}'
            
            # Clean up temp file
            rm -f "${temp_file}"
          }
          
          # Calculate SHA256 for ARM64 version
          echo "Calculating SHA256 for ARM64..."
          ARM_SHA="$(get_sha256 "https://github.com/abakum/crocgui/releases/download/v${NEW_VERSION}/crocgui-arm64.dmg")"
          export ARM_SHA
          
          # Calculate SHA256 for Intel version
          echo "Calculating SHA256 for Intel..."
          INTEL_SHA="$(get_sha256 "https://github.com/abakum/crocgui/releases/download/v${NEW_VERSION}/crocgui-amd64.dmg")"
          export INTEL_SHA
          
          echo "SHA256 hashes calculated:"
          echo "  ARM64: ${ARM_SHA}"
          echo "  Intel: ${INTEL_SHA}"
          
          # Update the cask file using Ruby for precise replacements
          echo "Updating cask file..."
          ruby <<-'RUBY'
            require 'yaml'
            
            file = ENV['CASK_FILE']
            content = File.read(file)
            
            # Replace version
            content.gsub!(/version "[\d\.]+"/, "version \"#{ENV['NEW_VERSION']}\"")
            
            # Replace ARM SHA256 (preserving formatting)
            content.gsub!(/sha256\s+arm:\s*"[a-f0-9]+"/, "sha256 arm:          \"#{ENV['ARM_SHA']}\"")
            
            # Replace Intel SHA256
            content.gsub!(/intel:\s*"[a-f0-9]+"/, "intel:        \"#{ENV['INTEL_SHA']}\"")
            
            File.write(file, content)
            puts "Cask file updated successfully"
          RUBY

      # Step 4: Commit and push changes to main branch
      - name: Commit and push changes
        if: steps.check_update.outputs.UPDATE == 'true'
        env:
          BRANCH_NAME: "update/crocgui-${{ steps.check_update.outputs.NEW_VERSION }}"
          COMMIT_MESSAGE: "Update crocgui from ${{ steps.check_update.outputs.OLD_VERSION }} to ${{ steps.check_update.outputs.NEW_VERSION }}"
        run: |
          # Configure git identity
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create a new branch for the update
          git checkout -b "${BRANCH_NAME}"
          
          # Add changes
          git add Casks/crocgui.rb
          
          # Check if there are any changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit (file already up to date)"
            exit 0
          fi
          
          # Commit changes
          git commit -m "${COMMIT_MESSAGE}"
          
          # Configure git to use the token for authentication
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          
          # Push changes to main branch
          echo "Pushing changes to main branch..."
          git push origin "${BRANCH_NAME}"
          
          # Switch back to main and merge
          git checkout main
          git merge "${BRANCH_NAME}" --no-ff -m "Merge: ${COMMIT_MESSAGE}"
          git push origin main
          
          echo "Successfully updated crocgui to version ${{ steps.check_update.outputs.NEW_VERSION }}"